name: AI Auto-Healing Pipeline

on:
  workflow_run:
    workflows: ["Cypress E2E Tests with Auto-Healing"]
    types: [completed]
    branches: [master, main]

jobs:
  auto-healing:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: master
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Download Cypress screenshots (if available)
      uses: actions/download-artifact@v4
      with:
        name: cypress-screenshots
        path: cypress/screenshots
        github-token: ${{ secrets.GITHUB_TOKEN }}
        repository: ${{ github.repository }}
        run-id: ${{ github.event.workflow_run.id }}
        
    - name: Download DOM content (if available)
      uses: actions/download-artifact@v4
      with:
        name: cypress-dom-content
        path: cypress/failures
        github-token: ${{ secrets.GITHUB_TOKEN }}
        repository: ${{ github.repository }}
        run-id: ${{ github.event.workflow_run.id }}
        
    - name: Analyze test failures
      run: |
        echo "ðŸ” Analyzing test failures for auto-healing..."
        echo "Test failure detected in workflow: ${{ github.event.workflow_run.name }}"
        echo "Workflow run ID: ${{ github.event.workflow_run.id }}"
        echo "Failure URL: ${{ github.event.workflow_run.html_url }}"
        
        # Check if artifacts were downloaded
        if [ -d "cypress/screenshots" ] && [ "$(ls -A cypress/screenshots 2>/dev/null)" ]; then
          echo "âœ… Screenshots found and downloaded"
          echo "ðŸ“¸ Available screenshots:"
          ls -la cypress/screenshots/
        else
          echo "âš ï¸ No screenshots available for analysis"
        fi
        
        # Check if DOM content was downloaded
        if [ -d "cypress/failures" ] && [ "$(ls -A cypress/failures 2>/dev/null)" ]; then
          echo "âœ… DOM content found and downloaded"
          echo "ðŸŒ Available DOM files:"
          ls -la cypress/failures/
          echo "ðŸ“‹ Raw files: $(find cypress/failures -name '*.html' ! -name '*-clean.html' | wc -l)"
          echo "ðŸ§¹ Cleaned files: $(find cypress/failures -name '*-clean.html' | wc -l)"
        else
          echo "âš ï¸ No DOM content available for analysis"
        fi
        
        # Note: Videos are disabled in cypress.json (video: false)
        echo "â„¹ï¸ Videos are disabled in Cypress configuration"
        
    - name: Build AI Payload
      run: |
        echo "ðŸ”§ Building AI payload for test failure analysis..."
        
        # Find the cleaned DOM file
        DOM_FILE=$(ls cypress/failures/*-clean.html | head -1)
        if [ ! -f "$DOM_FILE" ]; then
          echo "âŒ No cleaned DOM file found"
          exit 1
        fi
        
        # Build payload using the dedicated module
        node scripts/ai-payload-builder.js "$DOM_FILE"
        
        # Display full payload
        echo "::group::ðŸ“¤ OpenAI Request Payload"
        cat openai_payload.json
        echo "::endgroup::"
        
        # Extract test name from DOM file
        TEST_NAME=$(basename "$DOM_FILE" -clean.html 2>/dev/null || echo "Unknown test")
        
        echo "::group::ðŸ§ª Test Name"
        echo "$TEST_NAME"
        echo "::endgroup::"
        
        # Show error message if available
        ERROR_LOG_FILE="${DOM_FILE%-clean.html}.log.txt"
        if [ -f "$ERROR_LOG_FILE" ]; then
          echo "::group::âŒ Error Message"
          cat "$ERROR_LOG_FILE"
          echo "::endgroup::"
        else
          echo "::group::âŒ Error Message"
          echo "Error log not available"
          echo "::endgroup::"
        fi
        
        echo "::group::ðŸ§¹ Test HTML Context (Clean)"
        cat "$DOM_FILE"
        echo "::endgroup::"
        
        echo "::group::ðŸ“„ Full Test File"
        cat tests/e2e/new-todo.spec.js
        echo "::endgroup::"
        
        echo "âœ… OpenAI API payload prepared"
        
        # Send to OpenAI API
        if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
          echo "ðŸ”„ Sending request to OpenAI API..."
          OPENAI_RESPONSE=$(curl -s -X POST https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
            -d @openai_payload.json)
          echo "âœ… OpenAI API response received"
          echo "$OPENAI_RESPONSE" > openai_response.json
          
          if echo "$OPENAI_RESPONSE" | jq -e '.choices[0].message.content' > /dev/null 2>&1; then
            OPENAI_ANALYSIS=$(echo "$OPENAI_RESPONSE" | jq -r '.choices[0].message.content')
            
            echo "::group::ðŸ“Š OpenAI Full Response"
            echo "$OPENAI_RESPONSE" | jq '.'
            echo "::endgroup::"
            
            echo "::group::ðŸ¤– OpenAI Analysis Response"
            echo "$OPENAI_ANALYSIS"
            echo "::endgroup::"
            
            echo "$OPENAI_ANALYSIS" > openai_analysis.txt
            echo "âœ… OpenAI analysis saved for fix application"
          else
            echo "::group::âŒ OpenAI Response Error"
            echo "$OPENAI_RESPONSE" | jq '.' || echo "$OPENAI_RESPONSE"
            echo "::endgroup::"
          fi
        else
          echo "âš ï¸ OPENAI_API_KEY not found in secrets"
        fi
        
        echo "ðŸ“Š Context summary:"
        echo "- Test file: $(cat tests/e2e/new-todo.spec.js | wc -l) lines"
        echo "- DOM content: $(cat "$DOM_FILE" | wc -c) characters"
        echo "- Has screenshots: $([ -d "cypress/screenshots" ] && [ "$(ls -A cypress/screenshots 2>/dev/null)" ] && echo "Yes" || echo "No")"
        echo "- Has DOM content: $([ -d "cypress/failures" ] && [ "$(ls -A cypress/failures 2>/dev/null)" ] && echo "Yes" || echo "No")"
        
    - name: Parse AI Fix Response
      run: |
        echo "ðŸ” Parsing AI fix response..."
        
        if [ -f "openai_analysis.txt" ]; then
          echo "ðŸ“„ OpenAI analysis found, parsing structured fix..."
          
          # Parse and validate the AI response
          node scripts/fix-parser.js openai_analysis.txt
          
          if [ $? -eq 0 ]; then
            echo "âœ… AI fix response parsed and validated"
            echo "ðŸ“Š Fix details saved for application"
          else
            echo "âŒ Failed to parse AI response"
            echo "ðŸ“ Saving raw response for manual review"
            cp openai_analysis.txt recommended_fix.txt
          fi
          
        else
          echo "âš ï¸ No OpenAI analysis found"
          echo "ðŸ“ Creating placeholder for manual review"
          echo "No AI analysis available" > recommended_fix.txt
        fi
        
        echo "âœ… AI fix parsing completed"
        
    - name: Create auto-healing branch
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git checkout -b auto-healing/fix-${{ github.run_number }}-${{ github.sha }}
        
    - name: Apply AI-generated fixes
      run: |
        echo "ðŸ”§ Applying AI-generated fixes..."
        
        if [ -f "recommended_fix.txt" ]; then
          echo "ðŸ“„ Fix recommendations found"
          
          RECOMMENDED_FIX=$(cat recommended_fix.txt)
          echo "ðŸ” Recommended fix: $RECOMMENDED_FIX"
          
          # For now, just document the recommended fixes as comments
          echo "ðŸ“ Creating fix documentation..."
          
          # Create a summary of recommended changes
          echo "ðŸ“Š Summary of recommended fixes:" > fix_summary.txt
          echo "- Recommendation: $RECOMMENDED_FIX" >> fix_summary.txt
          echo "- Files to modify: tests/e2e/new-todo.spec.js" >> fix_summary.txt
          echo "- Change type: Selector/locator update" >> fix_summary.txt
          echo "- Status: Documented for manual review" >> fix_summary.txt
          
          echo "âœ… Fix recommendations documented"
          echo "ðŸ“‹ Manual review required to apply changes"
          
        else
          echo "âš ï¸ No fix recommendations found"
          echo "ðŸ“ Creating placeholder fix summary"
          
          cat > fix_summary.txt << EOF
        No specific fixes recommended.
        Manual review of test failure required.
        Check Claude analysis for detailed recommendations.
        EOF
        fi
        
        echo "âœ… Fix documentation completed"
        
    - name: Push auto-healing branch
      run: |
        git push origin auto-healing/fix-${{ github.run_number }}-${{ github.sha }}
        
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        title: "ðŸ¤– Auto-healing: Fix test failures"
        body: |
          ## AI Auto-Healing Fix
          
          This PR contains automated fixes for failing tests detected by the auto-healing pipeline.
          
          **Changes made:**
          - [ ] Updated selectors
          - [ ] Fixed timing issues  
          - [ ] Updated test expectations
          - [ ] Added retry mechanisms
          
          **Test Results:**
          - Original failure: ${{ github.event.workflow_run.html_url }}
          - Auto-healing run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          **Next Steps:**
          1. Review the changes
          2. Run tests locally
          3. Merge if tests pass
        branch: auto-healing/fix-${{ github.run_number }}-${{ github.sha }}
        base: master
        delete-branch: true 
